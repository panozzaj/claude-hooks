#!/bin/bash
# Script to run Prettier on changed files
# Usage:
#   - As Claude Code hook: receives JSON via STDIN
#   - Direct invocation: prettier_changed_files [-v|--verbose] [file1 file2 ...]
#
# Provides informative feedback by showing a unified diff of formatting changes.
# Uses Prettier's stdout output (default behavior) to compare against originals,
# following the design principle that auto-fix scripts should show what was corrected.
#
# See ../../docs/hook_interface.md for interface specification and exit code behavior

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Parse verbose flag
VERBOSE=false
FILES_ARG=()
for arg in "$@"; do
  if [ "$arg" = "-v" ] || [ "$arg" = "--verbose" ]; then
    VERBOSE=true
  else
    FILES_ARG+=("$arg")
  fi
done

# Determine file to check: either from STDIN JSON (Claude Code hook) or command-line args
CHANGED_FILES=""

# Check if we have command-line file arguments (for direct invocation / testing)
if [ ${#FILES_ARG[@]} -gt 0 ]; then
  CHANGED_FILES="${FILES_ARG[*]}"
else
  # No args - check if we're receiving JSON from STDIN (Claude Code hook mode)
  # Check if STDIN is not a terminal (i.e., data is being piped/redirected)
  if [ ! -t 0 ]; then
    # Read all of STDIN
    HOOK_JSON=$(cat)

    # Extract file_path from JSON using grep and sed
    # Handles both tool_input.file_path and tool_response.filePath
    FILE_PATH=$(echo "$HOOK_JSON" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || true)

    if [ -z "$FILE_PATH" ]; then
      # Try alternative field name
      FILE_PATH=$(echo "$HOOK_JSON" | grep -o '"filePath"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"filePath"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || true)
    fi

    # Only check files prettier handles (js, jsx, ts, tsx, json, css, scss, md, etc.)
    if [ -n "$FILE_PATH" ] && [[ "$FILE_PATH" =~ \.(js|jsx|ts|tsx|json|css|scss|less|md|html|yml|yaml)$ ]]; then
      CHANGED_FILES="$FILE_PATH"
    fi
  fi
fi

if [ -z "$CHANGED_FILES" ]; then
  echo -e "prettier: ${GRAY}N/A${NC}"
  exit 0
fi

# Determine Prettier command
if [ -x "./bin/prettier" ]; then
  PRETTIER_CMD="./bin/prettier"
elif command -v yarn &> /dev/null; then
  PRETTIER_CMD="yarn prettier"
else
  PRETTIER_CMD="npx prettier"
fi

if [ "$VERBOSE" = true ]; then
  echo "Changed files detected:"
  echo "$CHANGED_FILES" | sed 's/^/  /'
  echo ""
  echo "Running Prettier with auto-format..."
  echo ""
fi

# Run Prettier with auto-format
# Use prettier's built-in stdout output to generate diffs
PRETTIER_OUTPUT=$(mktemp)

# Use 'set +e' temporarily to capture exit status without script failing
set +e

# Run prettier without --write to get formatted output on stdout
# This allows us to diff against original before making changes
$PRETTIER_CMD $CHANGED_FILES > "$PRETTIER_OUTPUT" 2>&1
PRETTIER_STATUS=$?

if [ $PRETTIER_STATUS -ne 0 ]; then
  # Exit 2: blocking error - syntax errors prevent formatting
  echo "Prettier encountered errors:" >&2
  cat "$PRETTIER_OUTPUT" >&2
  echo "" >&2
  echo -e "prettier: ${RED}✗${NC}" >&2
  rm "$PRETTIER_OUTPUT"
  exit 2
fi

# Compare formatted output with original file to detect changes
CHANGES_DETECTED=false
DIFF_OUTPUT=""

for file in $CHANGED_FILES; do
  if [ -f "$file" ]; then
    # Get formatted version for this file
    FORMATTED=$(mktemp)
    $PRETTIER_CMD "$file" > "$FORMATTED" 2>&1

    # Check if file would change
    if ! diff -q "$file" "$FORMATTED" > /dev/null 2>&1; then
      CHANGES_DETECTED=true
      # Store the diff for this file
      FILE_DIFF=$(diff -u "$file" "$FORMATTED" | tail -n +3 || true)
      DIFF_OUTPUT="${DIFF_OUTPUT}Changes in $file:\n${FILE_DIFF}\n\n"
    fi

    rm "$FORMATTED"
  fi
done

if [ "$CHANGES_DETECTED" = false ]; then
  # No formatting changes needed
  rm "$PRETTIER_OUTPUT"
  echo -e "prettier: ${GREEN}✓${NC}"
  exit 0
fi

# Apply formatting with --write
WRITE_OUTPUT=$(mktemp)
$PRETTIER_CMD --write $CHANGED_FILES > "$WRITE_OUTPUT" 2>&1
WRITE_STATUS=$?
set -e

if [ $WRITE_STATUS -eq 0 ]; then
  # Exit 0: success - show what was formatted
  echo "Prettier formatted the following files:"
  cat "$WRITE_OUTPUT"
  echo ""

  # Show the diffs
  echo -e "$DIFF_OUTPUT"

  echo -e "prettier: ${GREEN}✓${NC}"
  rm "$PRETTIER_OUTPUT" "$WRITE_OUTPUT"
  exit 0
else
  # Exit 2: blocking error - write failed
  echo "Prettier encountered errors:" >&2
  cat "$WRITE_OUTPUT" >&2
  echo "" >&2
  echo -e "prettier: ${RED}✗${NC}" >&2
  rm "$PRETTIER_OUTPUT" "$WRITE_OUTPUT"
  exit 2
fi
