#!/bin/bash
# Script to run cargo clippy on changed Rust files
# Usage:
#   - As Claude Code hook: receives JSON via STDIN
#   - Direct invocation: cargo_clippy_changed_files [-v|--verbose] [file1 file2 ...]
#
# See ../../docs/hook_interface.md for interface specification and exit code behavior

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Parse verbose flag
VERBOSE=false
FILES_ARG=()
for arg in "$@"; do
  if [ "$arg" = "-v" ] || [ "$arg" = "--verbose" ]; then
    VERBOSE=true
  else
    FILES_ARG+=("$arg")
  fi
done

# Determine file to check: either from STDIN JSON (Claude Code hook) or command-line args
CHANGED_FILES=""

# Check if we have command-line file arguments (for direct invocation / testing)
if [ ${#FILES_ARG[@]} -gt 0 ]; then
  CHANGED_FILES="${FILES_ARG[*]}"
else
  # No args - check if we're receiving JSON from STDIN (Claude Code hook mode)
  if [ ! -t 0 ]; then
    HOOK_JSON=$(cat)

    # Extract file_path from JSON
    FILE_PATH=$(echo "$HOOK_JSON" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"file_path"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || true)

    if [ -z "$FILE_PATH" ]; then
      FILE_PATH=$(echo "$HOOK_JSON" | grep -o '"filePath"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"filePath"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || true)
    fi

    # Only check Rust files
    if [ -n "$FILE_PATH" ] && [[ "$FILE_PATH" =~ \.rs$ ]]; then
      CHANGED_FILES="$FILE_PATH"
    fi
  fi
fi

if [ -z "$CHANGED_FILES" ]; then
  echo -e "clippy: ${GRAY}N/A${NC}"
  exit 0
fi

# Find the Cargo.toml directory (walk up from the file)
find_cargo_root() {
  local dir="$1"
  while [ "$dir" != "/" ]; do
    if [ -f "$dir/Cargo.toml" ]; then
      echo "$dir"
      return 0
    fi
    dir=$(dirname "$dir")
  done
  return 1
}

# Get directory of the first file
FIRST_FILE=$(echo "$CHANGED_FILES" | awk '{print $1}')
if [ -f "$FIRST_FILE" ]; then
  FILE_DIR=$(dirname "$FIRST_FILE")
else
  FILE_DIR="."
fi

CARGO_ROOT=$(find_cargo_root "$(cd "$FILE_DIR" && pwd)" || true)

if [ -z "$CARGO_ROOT" ]; then
  echo -e "clippy: ${GRAY}N/A (no Cargo.toml found)${NC}"
  exit 0
fi

if [ "$VERBOSE" = true ]; then
  echo "Changed Rust files detected:"
  echo "$CHANGED_FILES" | sed 's/^/  /'
  echo ""
  echo "Running cargo clippy in $CARGO_ROOT..."
  echo ""
fi

# Run cargo clippy with auto-fix
CLIPPY_OUTPUT=$(mktemp)

set +e
# Use --fix to auto-apply suggestions, --allow-dirty since we're in a working dir
(cd "$CARGO_ROOT" && cargo clippy --fix --allow-dirty --allow-staged 2>&1) > "$CLIPPY_OUTPUT"
CLIPPY_STATUS=$?
set -e

# Filter out "Compiling" and "Checking" noise, keep warnings/errors
filter_cargo_noise() {
  grep -v "^[[:space:]]*Compiling" | \
  grep -v "^[[:space:]]*Checking" | \
  grep -v "^[[:space:]]*Finished" | \
  grep -v "^[[:space:]]*Fresh" | \
  grep -v "^[[:space:]]*Downloading" | \
  grep -v "^[[:space:]]*Downloaded" | \
  sed '/^$/N;/^\n$/D'
}

FILTERED_OUTPUT=$(cat "$CLIPPY_OUTPUT" | filter_cargo_noise)

if [ $CLIPPY_STATUS -eq 0 ]; then
  if [ -n "$FILTERED_OUTPUT" ]; then
    echo "$FILTERED_OUTPUT"
    echo ""
  fi
  echo -e "clippy: ${GREEN}✓${NC}"
  rm "$CLIPPY_OUTPUT"
  exit 0
else
  # Errors that couldn't be auto-fixed
  if [ -n "$FILTERED_OUTPUT" ]; then
    echo "$FILTERED_OUTPUT" >&2
    echo "" >&2
  fi
  echo -e "clippy: ${RED}✗${NC}" >&2
  rm "$CLIPPY_OUTPUT"
  exit 2
fi
