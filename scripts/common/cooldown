#!/bin/bash
# Shared cooldown helper for Stop hooks.
# Prevents the same hook from blocking repeatedly in the same session.
#
# Usage:
#   cooldown check SESSION_ID HOOK_NAME [COOLDOWN_SECONDS]
#     Exit 0 = OK to proceed (not in cooldown)
#     Exit 1 = in cooldown, skip blocking
#
#   cooldown record SESSION_ID HOOK_NAME
#     Records current timestamp as last block time
#
# Default cooldown: 300 seconds (5 minutes). Override via STOP_HOOK_COOLDOWN env var.
# Cooldown files stored in $TMPDIR (cleaned on reboot).

ACTION="$1"
SESSION_ID="$2"
HOOK_NAME="$3"

if [ -z "$SESSION_ID" ] || [ -z "$HOOK_NAME" ]; then
  exit 0
fi

COOLDOWN_FILE="${TMPDIR:-/tmp}/claude_stop_${SESSION_ID}_${HOOK_NAME}"

case "$ACTION" in
  check)
    COOLDOWN_SECONDS="${4:-${STOP_HOOK_COOLDOWN:-300}}"
    if [ -f "$COOLDOWN_FILE" ]; then
      LAST_BLOCK=$(cat "$COOLDOWN_FILE")
      NOW=$(date +%s)
      if [ $((NOW - LAST_BLOCK)) -lt "$COOLDOWN_SECONDS" ]; then
        exit 1
      fi
    fi
    exit 0
    ;;
  record)
    date +%s > "$COOLDOWN_FILE"
    exit 0
    ;;
esac
